# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do

  coreVersionNumber = get_version_number(
    xcodeproj: "Core/Core.xcodeproj",
    target: "Core",
  )
  coreBuildNumber = get_build_number(
    xcodeproj: "Core/Core.xcodeproj",
  )
  p "get RPSCore version = #{coreVersionNumber}, build = #{coreBuildNumber}"

  rdnVersionNumber = get_version_number(
    xcodeproj: "RDN/RDN.xcodeproj",
    target: "RDN",
  )
  rdnBuildNumber = get_build_number(
    xcodeproj: "RDN/RDN.xcodeproj",
  )
  p "get RPSCore version = #{rdnVersionNumber}, build = #{rdnBuildNumber}"

  sdk_output_dir = "build/Release"

  lane :packageCore do
    xcodebuild(
      raw_buildlog: true,
      project: "Core/Core.xcodeproj",
      target: "Aggregate",
      configuration: "Release",
      build_settings: { :SDK_OUTPUT_DIR => sdk_output_dir },
    )
  end

  lane :packageRDN do
    xcodebuild(
      raw_buildlog: true,
      project: "RDN/RDN.xcodeproj",
      target: "Aggregate",
      configuration: "Release",
      build_settings: { :SDK_OUTPUT_DIR => sdk_output_dir },
    )
  end


  lane :deploy_to_gcs_dev do |param|
    google_cloud_storage_upload(
      project: "rd2n-dev",
      keyfile: ENV["FASTLANE_GCS_CREDENTIAL"],
      bucket: "dev-s-cdn.rx-ad.com",
      content_path: "RsspSDK/#{sdk_output_dir}/#{param[:file_name]}",
      name: "sdk/ios/#{version}/#{param[:file_name]}",
    )
  end

  lane :deploy_to_gcs do |param|
      p "TODO"
  end

  lane :update_podspec do
    version_bump_podspec(
      path: "Rssp.podspec",
      version_number: version,
    )

    pod_push(
      path: "Rssp.podspec",
      repo: 'lob-inc',
    )
  end

  lane :github_release_tag do
    set_github_release(
      repository_name: "lob-inc/rssp.ios.repo",
      api_token: ENV["GITHUB_TOKEN"],
      name: version,
      tag_name: version,
      description: "release for #{version}",
      upload_assets: ["RsspSDK/#{sdk_output_dir}/RsspSDK_iOS_dynamic_#{version}.framework.zip"],
    )
  end

  lane :release do
    # packageCore
    # packageRDN
    # deploy_to_gcs_dev file_name: "RsspSDK_iOS_dynamic_#{version}.framework.zip"
    # deploy_to_gcs_dev file_name: "RsspSDK_iOS_static_#{version}.zip"
    # update_podspec
    # github_release_tag
  end
end

